#!/usr/bin/env bash
# pre-commit ‚Äî runs before every commit.
# Mirrors the "Format check" step in .github/workflows/rust.yml.
#
# Install once: git config core.hooksPath .githooks
#   or run:     .githooks/install.sh

set -euo pipefail

# Track whether we had to auto-fix anything
NEEDS_RESTAGE=false

echo "üîç pre-commit: checking formatting..."

if ! cargo fmt --check --quiet 2>&1; then
  echo "  ‚ÑπÔ∏è  Auto-fixing formatting issues..."
  cargo fmt --quiet
  echo "  ‚ö†Ô∏è  Formatting was auto-fixed. Please review and re-stage the files:"
  git diff --name-only
  echo ""
  NEEDS_RESTAGE=true
fi

echo "‚úÖ Formatting OK."

echo "üîç pre-commit: running clippy..."

if ! cargo clippy --workspace -- -D warnings 2>&1; then
  echo ""
  echo "‚ùå Clippy errors found. Fix them and stage the changes before committing."
  exit 1
fi

echo "‚úÖ Clippy OK."

echo "üîç pre-commit: running docs check..."

export RUSTDOCFLAGS='-D warnings'
if ! cargo doc --workspace --no-deps --quiet 2>&1; then
  echo ""
  echo "‚ùå Documentation warnings/errors found. Fix them and stage the changes before committing."
  exit 1
fi
unset RUSTDOCFLAGS

echo "‚úÖ Docs OK."

if [ "$NEEDS_RESTAGE" = true ]; then
  echo ""
  echo "‚ö†Ô∏è  Files were auto-formatted. Please review, stage them, and commit again:"
  echo "    git add <files>"
  echo "    git commit"
  exit 1
fi
