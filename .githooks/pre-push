#!/usr/bin/env bash
# pre-push â€” runs before every 'git push'.
# Mirrors the "Lint" and "Tests" jobs in .github/workflows/rust.yml.
#
# Install once: git config core.hooksPath .githooks
#   or run:     .githooks/install.sh

set -euo pipefail

# double-check formatting as early as possible (pipeline lint job also runs this)
 echo "ğŸ” pre-push: checking formatting..."

 if ! cargo fmt --check --quiet 2>&1; then
   echo ""
   echo "âŒ Formatting issues found. Run 'cargo fmt' to fix them, then re-stage."
   exit 1
 fi

echo "âœ… Formatting OK."

echo "ğŸ” pre-push: running clippy..."

if ! cargo clippy --workspace --quiet -- -D warnings 2>&1; then
  echo ""
  echo "âŒ Clippy errors. Fix them before pushing."
  exit 1
fi

echo "âœ… Clippy OK."
echo "ğŸ” pre-push: running docs check..."

# mirror CI's doc step to catch rustdoc warnings early
export RUSTDOCFLAGS="-D warnings"
if ! cargo doc --workspace --no-deps --quiet 2>&1; then
  echo ""
  echo "âŒ Documentation warnings/errors; fix them before pushing."
  exit 1
fi
unset RUSTDOCFLAGS

echo "âœ… Docs OK."

# ensure the commits we're about to push are themselves lint-clean
# (this protects against pushing from a clone where the hooks weren't enabled)
echo "ğŸ” pre-push: linting commits being pushed..."
while read -r local_ref local_sha remote_ref remote_sha; do
  # skip deletes
  if [ "${local_sha}" = "0000000000000000000000000000000000000000" ]; then
    continue
  fi
  echo "  checking $local_ref ($local_sha)"
  tmpdir=$(mktemp -d)
  # `-q` option not available on some git versions (e.g. older macOS); ignore errors
  git worktree add "$tmpdir" "$local_sha" 2>/dev/null || git worktree add "$tmpdir" "$local_sha"
  pushd "$tmpdir" >/dev/null
  if ! cargo fmt --check --quiet 2>&1; then
    echo ""
    echo "âŒ Formatting issues in commit $local_sha";
    exit 1
  fi
  if ! cargo clippy --workspace --quiet -- -D warnings 2>&1; then
    echo ""
    echo "âŒ Clippy errors in commit $local_sha";
    exit 1
  fi
  if ! RUSTDOCFLAGS="-D warnings" cargo doc --workspace --no-deps --quiet 2>&1; then
    echo ""
    echo "âŒ Documentation warnings/errors in commit $local_sha";
    exit 1
  fi
  popd >/dev/null
  # drop the temporary worktree; avoid -q which may not exist
  git worktree remove "$tmpdir" >/dev/null 2>&1 || git worktree remove "$tmpdir"
done

echo "âœ… pushed commits are lint-clean."

echo "ğŸ” pre-push: running tests..."

if cargo nextest run --workspace --quiet 2>/dev/null; then
  echo "âœ… Tests OK (nextest)."
elif cargo test --workspace --quiet 2>&1; then
  echo "âœ… Tests OK."
else
  echo ""
  echo "âŒ Tests failed. Fix them before pushing."
  exit 1
fi
