#!/usr/bin/env bash
# pre-push â€” runs before every 'git push'.
# Mirrors the "Lint" and "Tests" jobs in .github/workflows/rust.yml.
#
# Install once: git config core.hooksPath .githooks
#   or run:     .githooks/install.sh

set -euo pipefail

# double-check formatting as early as possible (pipeline lint job also runs this)
 echo "ğŸ” pre-push: checking formatting..."

 if ! cargo fmt --check --quiet 2>&1; then
   echo ""
   echo "âŒ Formatting issues found. Run 'cargo fmt' to fix them, then re-stage."
   exit 1
 fi

echo "âœ… Formatting OK."

echo "ğŸ” pre-push: running clippy..."

if ! cargo clippy --workspace --quiet -- -D warnings 2>&1; then
  echo ""
  echo "âŒ Clippy errors. Fix them before pushing."
  exit 1
fi

echo "âœ… Clippy OK."
echo "ğŸ” pre-push: running docs check..."

# mirror CI's doc step to catch rustdoc warnings early
if ! RUSTDOCFLAGS=-D warnings cargo doc --workspace --no-deps --quiet 2>&1; then
  echo ""
  echo "âŒ Documentation warnings/errors; fix them before pushing."
  exit 1
fi

echo "âœ… Docs OK."

echo "ğŸ” pre-push: running tests..."

if cargo nextest run --workspace --quiet 2>/dev/null; then
  echo "âœ… Tests OK (nextest)."
elif cargo test --workspace --quiet 2>&1; then
  echo "âœ… Tests OK."
else
  echo ""
  echo "âŒ Tests failed. Fix them before pushing."
  exit 1
fi
